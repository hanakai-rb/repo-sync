#!/bin/bash

# Usage: bin/local-sync path/to/local/target/repo

set -e

REPO_SYNC_ROOT=$(pwd)
DOCKER_IMAGE="repo-sync-local"
DOCKER_DIR="${REPO_SYNC_ROOT}/local-sync"

if [ $# -lt 1 ]; then
  echo "Usage: $0 path/to/repo"
  echo "  path/to/repo: Path to a local repository for testing a sync"
  exit 1
fi

TARGET_REPO_DIR=$(realpath "$1")

if [ ! -d "$TARGET_REPO_DIR" ]; then
  echo "Error: Repository directory does not exist: $TARGET_REPO_DIR"
  exit 1
fi

docker build -q -t "${DOCKER_IMAGE}" "${DOCKER_DIR}" > /dev/null

docker run --rm \
  -v "${REPO_SYNC_ROOT}:/workspace" \
  -v "${TARGET_REPO_DIR}:/target" \
  "${DOCKER_IMAGE}" "/target"

if ! (cd "$TARGET_REPO_DIR" && git diff --quiet && git diff --staged --quiet); then
  echo "Changes:"
  (cd "$TARGET_REPO_DIR" && git status --short)
else
  echo "No files changed."
fi
