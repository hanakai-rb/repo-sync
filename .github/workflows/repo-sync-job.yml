name: Repo sync job

on:
  workflow_call:
    inputs:
      group:
        description: Name of the group to sync (from repo-sync.yml)
        required: true
        type: string
      id:
        description: Identifier of the calling job
        required: true
        type: string

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v2
      - name: Load config
        id: config
        run: |
          CONFIG_FILE="repo-sync.yml"

          # Extract repos for the specified group
          REPOS=$(yq eval ".${{ inputs.group }}.repos | .[]" "$CONFIG_FILE")
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          echo "$REPOS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract files for the specified group and convert from [source, target] pairs to source=target format
          FILES=$(yq eval ".${{ inputs.group }}.files | map(.[0] + \"=\" + .[1]) | .[]" "$CONFIG_FILE")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Sync
        id: sync
        uses: ./repo-sync-action
        with:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_EVENT_TYPE: ${{ github.event.action }}
          REPOSITORIES: ${{ steps.config.outputs.repos }}
          FILES: ${{ steps.config.outputs.files }}
          REPO_SYNC_SCHEMA_PATH: templates/repo-sync-schema.json
          TOKEN: ${{ secrets.REPO_SYNC_TOKEN }}
      - name: Comment
        if: github.event.pull_request.number
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: ${{ steps.sync.outputs.SYNC_SUMMARY || '' }}
          pr-number: ${{ github.event.pull_request.number }}
          comment-tag: sync-summary-${{ inputs.id }}
          mode: ${{ github.event.action == 'closed' && 'delete' || 'upsert' }}
