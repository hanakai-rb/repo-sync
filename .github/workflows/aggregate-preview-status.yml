name: Preview status

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number"
        required: true
      repo_name:
        description: "Repository name"
        required: true
      workflow_name:
        description: "Workflow name"
        required: true
      status:
        description: "Workflow status"
        required: true
      run_url:
        description: "Workflow run URL"
        required: true

concurrency:
  group: preview-status-${{ github.event.inputs.pr_number }}
  cancel-in-progress: false

permissions:
  pull-requests: write

jobs:
  update_comment:
    runs-on: ubuntu-latest
    steps:
      - name: Build status table
        id: build-table
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.inputs.pr_number;
            const repoName = context.payload.inputs.repo_name;
            const workflowName = context.payload.inputs.workflow_name;
            const status = context.payload.inputs.status;
            const runUrl = context.payload.inputs.run_url;

            const statusKey = `${repoName} / ${workflowName}`;
            console.log(`Received status from ${statusKey}: ${status}`);

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const COMMENT_TAG = "ci-status";
            const botComment = comments.data.find(c =>
              c.user.login === "github-actions[bot]" &&
              c.body.includes(`<!-- comment-tag: ${COMMENT_TAG} -->`)
            );

            let statuses = {};

            if (botComment) {
              const jsonMatch = botComment.body.match(/<!-- status-data: (.+?) -->/);
              if (jsonMatch) {
                try {
                  statuses = JSON.parse(jsonMatch[1]);
                } catch (e) {
                  console.log("Failed to parse existing statuses, starting fresh");
                }
              }
            }

            const statusEmoji = {
              "success": "‚úÖ",
              "failure": "‚ùå"
            };
            const emoji = statusEmoji[status];

            statuses[statusKey] = {
              repo: repoName,
              workflow: workflowName,
              emoji: emoji,
              status: status,
              url: runUrl
            };

            const sortedRepos = Object.keys(statuses).sort();

            let body = `<!-- status-data: ${JSON.stringify(statuses)} -->\n`;
            body += "### üîç CI status\n\n";
            body += "| Repo | Workflow |\n";
            body += "|------|----------|\n";
            for (const key of sortedRepos) {
              const { repo, workflow, emoji, status, url } = statuses[key];
              const workflowText = emoji ? `${emoji} ${workflow}` : workflow;
              body += `| **${repo}** | ${workflowText} ¬∑ [${status}](${url}) |\n`;
            }

            core.setOutput("message", body);
            core.setOutput("pr_number", prNumber);

      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: ${{ steps.build-table.outputs.message }}
          pr-number: ${{ steps.build-table.outputs.pr_number }}
          # Must match COMMENT_TAG in the script above
          comment-tag: ci-status
