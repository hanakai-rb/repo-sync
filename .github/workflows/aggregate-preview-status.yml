name: Preview status

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number"
        required: true
      repo_name:
        description: "Repository name"
        required: true
      workflow_name:
        description: "Workflow name"
        required: true
      status:
        description: "Workflow status"
        required: true
      run_url:
        description: "Workflow run URL"
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update_comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write status to cache branch
        run: |
          PR_NUMBER="${{ github.event.inputs.pr_number }}"
          REPO_NAME="${{ github.event.inputs.repo_name }}"
          WORKFLOW_NAME="${{ github.event.inputs.workflow_name }}"
          STATUS="${{ github.event.inputs.status }}"
          RUN_URL="${{ github.event.inputs.run_url }}"

          CACHE_BRANCH="ci-status-cache-pr-${PR_NUMBER}"
          FILE_NAME=$(echo "${REPO_NAME}-${WORKFLOW_NAME}" | sed 's/[^a-zA-Z0-9]/-/g')
          FILE_PATH=".ci-status-cache/${FILE_NAME}.json"

          echo "Writing status for ${REPO_NAME} / ${WORKFLOW_NAME} to ${CACHE_BRANCH}:${FILE_PATH}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create or checkout cache branch
          if git ls-remote --heads origin "${CACHE_BRANCH}" | grep -q "${CACHE_BRANCH}"; then
            git fetch origin "${CACHE_BRANCH}"
            git checkout "${CACHE_BRANCH}"
          else
            git checkout -b "${CACHE_BRANCH}"
          fi

          # Create directory and write status file
          mkdir -p .ci-status-cache
          cat > "${FILE_PATH}" <<EOF
          {
            "repo": "${REPO_NAME}",
            "workflow": "${WORKFLOW_NAME}",
            "status": "${STATUS}",
            "url": "${RUN_URL}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF

          # Commit and push with retry logic for race conditions
          git add "${FILE_PATH}"
          git commit -m "Update status: ${REPO_NAME} / ${WORKFLOW_NAME} = ${STATUS}"

          MAX_RETRIES=5
          for i in $(seq 1 $MAX_RETRIES); do
            if git push origin "${CACHE_BRANCH}"; then
              echo "Successfully pushed on attempt $i"
              break
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "Push failed on attempt $i, retrying..."
                sleep $i
                git pull --rebase origin "${CACHE_BRANCH}"
              else
                echo "Failed to push after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Aggregate statuses
        id: aggregate
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const prNumber = context.payload.inputs.pr_number;

            console.log("Aggregating statuses from .ci-status-cache/");

            // Check if directory exists
            const cacheDir = ".ci-status-cache";
            if (!fs.existsSync(cacheDir)) {
              console.log("Cache directory not found");
              core.setOutput("message", "");
              core.setOutput("pr_number", prNumber);
              return;
            }

            // Read all JSON files
            const files = fs.readdirSync(cacheDir).filter(f => f.endsWith(".json"));
            if (files.length === 0) {
              console.log("No status files found");
              core.setOutput("message", "");
              core.setOutput("pr_number", prNumber);
              return;
            }

            // Parse all status files
            const statuses = {};
            for (const file of files) {
              try {
                const content = fs.readFileSync(path.join(cacheDir, file), "utf8");
                const statusData = JSON.parse(content);

                const statusKey = `${statusData.repo} / ${statusData.workflow}`;

                const statusEmoji = {
                  "success": "‚úÖ",
                  "failure": "‚ùå"
                };

                statuses[statusKey] = {
                  repo: statusData.repo,
                  workflow: statusData.workflow,
                  emoji: statusEmoji[statusData.status],
                  status: statusData.status,
                  url: statusData.url
                };
              } catch (error) {
                console.log(`Failed to read status file ${file}: ${error.message}`);
              }
            }

            const sortedKeys = Object.keys(statuses).sort();

            let body = "### üîç CI status\n\n";
            body += "| Repo | Workflow |\n";
            body += "|------|----------|\n";
            for (const key of sortedKeys) {
              const { repo, workflow, emoji, status, url } = statuses[key];
              const workflowText = emoji ? `${emoji} ${workflow}` : workflow;
              body += `| **${repo}** | ${workflowText} ¬∑ [${status}](${url}) |\n`;
            }

            core.setOutput("message", body);
            core.setOutput("pr_number", prNumber);

      - name: Comment PR
        if: steps.aggregate.outputs.message != ''
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: ${{ steps.aggregate.outputs.message }}
          pr-number: ${{ steps.aggregate.outputs.pr_number }}
          comment-tag: ci-status
