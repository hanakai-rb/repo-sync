name: Cleanup previews job

on:
  workflow_call:
    inputs:
      group:
        description: Name of the group to sync (from repo-sync.yml)
        required: true
        type: string
      id:
        description: Identifier of the calling job
        required: true
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v2

      - name: Load config
        id: config
        run: |
          CONFIG_FILE="repo-sync.yml"

          # Extract repos for the specified group
          REPOS=$(yq eval ".${{ inputs.group }}.repos | .[]" "$CONFIG_FILE")
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          echo "$REPOS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Cleanup stale branches
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_SYNC_TOKEN }}
          REPOSITORIES: ${{ steps.config.outputs.repos }}
          PREVIEW_BRANCH_PREFIX: "ci/repo-sync-preview"
        run: |
          set -e

          echo "### üßπ Stale branch cleanup summary" >> $GITHUB_STEP_SUMMARY
          echo >> $GITHUB_STEP_SUMMARY

          # Fetch all open PR numbers from this repo once
          OPEN_PR_NUMBERS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${GITHUB_REPOSITORY}/pulls?state=open" \
            --jq ".[].number" 2>/dev/null || echo "")

          # Read repositories into array
          mapfile -t REPOS <<< "$REPOSITORIES"

          for repository in "${REPOS[@]}"; do
            # Skip empty lines
            [[ -z "$repository" ]] && continue

            echo "::group::üìÇ $repository"

            # Extract repo name (handle optional @branch suffix)
            IFS="@" read -ra REPO_INFO <<< "$repository"
            REPO_NAME="${REPO_INFO[0]}"

            # Get all branches matching the preview pattern
            PREVIEW_BRANCHES=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${REPO_NAME}/branches" \
              --jq ".[] | select(.name | startswith(\"${PREVIEW_BRANCH_PREFIX}-\")) | .name" 2>/dev/null || echo "")

            if [[ -z "$PREVIEW_BRANCHES" ]]; then
              echo "‚ö™ **${repository}** - No preview branches" >> $GITHUB_STEP_SUMMARY
              echo >> $GITHUB_STEP_SUMMARY
              echo "::endgroup::"
              continue
            fi

            DELETED_COUNT=0
            KEPT_COUNT=0

            while IFS= read -r branch; do
              [[ -z "$branch" ]] && continue

              # Extract PR number from branch name
              PR_NUMBER="${branch#${PREVIEW_BRANCH_PREFIX}-}"

              # Check if the PR number is in our list of open PRs
              if echo "$OPEN_PR_NUMBERS" | grep -q "^${PR_NUMBER}$"; then
                ((KEPT_COUNT++))
              else
                # Delete the branch
                if gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "/repos/${REPO_NAME}/git/refs/heads/${branch}" 2>/dev/null; then
                  echo "  üóëÔ∏è  Deleted ${branch} (PR #${PR_NUMBER})"
                  ((DELETED_COUNT++))
                else
                  echo "  ‚ö†Ô∏è  Failed to delete ${branch} (PR #${PR_NUMBER})"
                fi
              fi
            done <<< "$PREVIEW_BRANCHES"

            if [[ $DELETED_COUNT -gt 0 ]]; then
              echo "üßπ **${repository}** - Deleted ${DELETED_COUNT} stale branch(es), kept ${KEPT_COUNT}" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö™ **${repository}** - No stale branches (${KEPT_COUNT} active)" >> $GITHUB_STEP_SUMMARY
            fi
            echo >> $GITHUB_STEP_SUMMARY

            echo "::endgroup::"
          done
